# JavaScript 性能优化

## 内存管理

介绍
- 内存：由可读写单元组成，表示一片可操作空间
- 管理：人为的去操作一片空间的申请、使用和释放
- 内存管理：开发者主动申请空间、使用空间、释放空间
- 管理流程：申请-使用-释放


## 垃圾回收与常见 GC 算法

JavaScript 中的垃圾
- JS 中的内存管理是自动的
- 对象不再被引用时是垃圾
- 对象不能从根上访问到时是垃圾

JavaScript 中的可达对象
- 可以访问到的对象就是可达对象（引用、作用域链）
- 可达的标准就是从根出发是否能够被找到
- JS 中的根就可以理解为是全局变量对象

### 引用计数算法
- 核心思想：设置引用数，判断当前对象引用数是否为0
- 引用计数器
- 引用关系改变时修改引用数字
- 引用数字为0时立即回收

引用计数算法优点：
- 发现垃圾时立即回收
- 最大限度减少程序暂停

引用计数算法缺点：
- 无法回收循环引用的对象
- 时间开销大，资源消耗较大

### 标记清除算法
- 核心思想：分标记和清除两个阶段完成
- 遍历所有对象找标记活动对象
- 遍历所有对象清除没有标记的对象
- 回收相应的空间

标记清除算法优点：
- 相对于引用计数算法，它可以回收循环引用的对象

标记清除算法缺点：
- 它释放的空间是分散的，地址不连续
- 会产生空间碎片化的问题，浪费空间
- 不会立即回收垃圾对象

### 标记整理算法
- 标记整理可以看做是标记清除的增强
- 标记阶段的操作和标记清除一致
- 清除阶段会先执行整理，移动对象的位置

标记整理算法优缺点：
- 减少碎片化空间
- 不会立即回收垃圾对象


## V8 引擎的垃圾回收

### 认识V8
- V8 是一款主流的 JavaScript 执行引擎
- V8 采用即时编译，速度很快
- V8 内存设限，64位操作系统最大1.5G，32位操作系统最大800M

### V8 垃圾回收策略
- 采用分代回收的思想
- 内存分为新生代、老生代
- 针对不同对象采用不同算法

V8 中常用的 GC(Garbage Collection) 算法
- 分代回收、空间复制、标记清除、标记整理、标记增量

### V8 内存分配
- V8 内存空间一分为二
- 小空间用于存储新生代对象（64位操作系统：32M，32位操作系统：16M）
- 新生代指的是存活时间较短的对象

### 新生代对象回收实现
- 回收过程采用复制算法 + 标记整理
- 新生代内存区分为两个等大小空间 From 和 To
- 使用空间为 From，空闲空间为 To
- 活动对象存储在 From 空间，标记整理后将活动对象拷贝至 To
- From 与 To 交换空间之后完成内存释放

回收细节说明
- 拷贝过程中可能出现晋升
- 晋升就是将新生代对象移动至老生代
- 一轮 GC 还存活的新生代需要晋升
- To 空间的使用率超过 25%，也要将活动对象移动至老生代

### 老生代对象说明
- 老生代对象存放在右侧的老生代区域
- 64位操作系统 1.4G，32位操作系统 700M
- 老生代对象就是指存活时间较长的对象

### 老生代对象回收实现
- 主要采用标记清除、标记整理、增量标记算法
- 首先使用标记清除完成垃圾空间的回收
- 采用标记整理进行空间优化
- 采用增量标记进行效率优化

细节对比
- 新生代区域垃圾回收使用空间换时间
- 老生代区域垃圾回收不适合复制算法

### V8 总结
- V8 是一款主流的 JavaScript 执行引擎
- V8 内存设置上限（从web应用、用户体验考虑）
- V8 采用基于分代回收思想实现垃圾回收
- V8 内存分为新生代和老生代
- V8 垃圾回收常见的 GC 算法


## Performance 工具

### 为什么使用 Performance
- GC 的目的是为了实现内存空间的良性循环
- 良性循环的基石是合理使用
- 时刻关注才能确定是否合理
- Performance 提供多种监控方式

### Performance 使用步骤
- 打开浏览器输入目标网址
- 进入开发人员工具面板，选择性能
- 开启录制功能，访问具体界面
- 执行用户行为，一段时间后停止录制
- 分析界面中记录的内存信息

### 内存问题的外在表现
- 页面出现延迟加载或经常性暂停
- 页面持续性出现糟糕的性能
- 页面的性能随时间延长越来越差

### 界定内存问题的标准
- 内存泄漏：内存使用持续升高
- 内存膨胀：在多数设备上都存在性能问题
- 频繁垃圾回收：通过内存变化图进行分析

### 监控内存的几种方式
- 浏览器任务管理器
- Timeline 时序图记录
- 堆快照查找分离 DOM
- 判断是否存在频繁的垃圾回收


## 代码优化实例

